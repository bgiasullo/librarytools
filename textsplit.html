<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Image-split Text Cleaner</title>

<style>
  body { font-family: sans-serif; margin: 20px; }
  .wrap { max-width: 900px; margin: auto; }
  h1 { margin-bottom: 10px; font-size: 20px; }
  .controls, .file-item { display: flex; gap: 8px; flex-wrap: wrap; }
  .drop { border: 2px dashed #ccc; padding: 20px; text-align: center; margin: 12px 0; }
  button { padding: 6px 10px; cursor: pointer; }
  ul { list-style: none; padding: 0; }
  .file-item { justify-content: space-between; background: #f5f5f5; padding: 8px; margin-bottom: 8px; }
  pre { white-space: pre-wrap; background: #222; color: #fff; padding: 10px; margin-top: 6px; }
  .small { font-size: 13px; color: #666; margin-top: 10px; }
</style>
</head>

<body>
<div class="wrap">
  <h1>Split text file into multiple files</h1>
  <p>Uploads a .txt file, splits on <code>Image &lt;number&gt;</code>, removes the marker and a leading “Transcription:”, preserves line breaks, and allows individual or ZIP download.</p>

  <div class="controls">
    <input id="fileInput" type="file" accept=".txt">
    <button id="processBtn">Process</button>
    <button id="clearBtn">Clear</button>
  </div>

  <div id="dropZone" class="drop">Or drag & drop a .txt file here</div>
  <div id="status" class="small"></div>

  <ul id="outputList" hidden></ul>

  <div id="zipWrap" hidden>
    <button id="downloadZip">Download ZIP</button>
  </div>

  <div class="small">All processing occurs in your browser—nothing is uploaded.</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<script>
const $ = id => document.getElementById(id);
const fileInput = $('fileInput');
const outputList = $('outputList');
const status = $('status');
const zipWrap = $('zipWrap');
let splitFiles = [];

// ------------------ UI Helpers ------------------
function setStatus(t) { status.textContent = t; }
function resetUI() {
  outputList.innerHTML = '';
  outputList.hidden = true;
  zipWrap.hidden = true;
  splitFiles = [];
  setStatus('');
  fileInput.value = '';
}

$('clearBtn').onclick = resetUI;
$('processBtn').onclick = handleProcess;

// ------------------ Drag & Drop ------------------
['dragenter','dragover'].forEach(ev => {
  $('dropZone').addEventListener(ev, e => { e.preventDefault(); });
});
$('dropZone').addEventListener('drop', e => {
  e.preventDefault();
  if (e.dataTransfer.files[0]) fileInput.files = e.dataTransfer.files;
});

// ------------------ Processing ------------------
function handleProcess() {
  const file = fileInput.files[0];
  if (!file) return setStatus('Choose a .txt file first.');
  setStatus('Reading...');

  const reader = new FileReader();
  reader.onload = e => {
    try {
      const text = e.target.result;
      const parts = splitByImage(text);
      if (!parts.length) return setStatus('No Image <number> markers found.');

      buildList(parts);
      setStatus(`Created ${parts.length} file(s).`);
    } catch (err) {
      console.error(err);
      setStatus('Error: ' + err.message);
    }
  };
  reader.onerror = () => setStatus('Error reading file.');
  reader.readAsText(file, 'utf-8');
}

// Core splitting logic
function splitByImage(text) {
  const regex = /Image\s+(\d+)\s*([\s\S]*?)(?=Image\s+\d+|$)/gi;
  const out = [];
  let m;

  while ((m = regex.exec(text))) {
    let content = m[2]
      .replace(/^\s*Transcription:\s*/i, '')   // drop leading "Transcription:"
      .replace(/^\n+|\n+$/g, '');              // trim leading/trailing newlines only

    out.push({
      name: `image_${m[1]}.txt`,
      text: content
    });
  }
  return out;
}

// Build download list
function buildList(parts) {
  outputList.innerHTML = '';
  outputList.hidden = false;
  zipWrap.hidden = false;

  splitFiles = parts.map(p =>
    ({ name: p.name, blob: new Blob([p.text], {type:'text/plain'}) })
  );

  parts.forEach((p, i) => {
    const li = document.createElement('li');
    li.className = 'file-item';

    li.innerHTML = `
      <div>
        <strong>${p.name}</strong>
        <pre>${p.text.slice(0, 800)}${p.text.length > 800 ? '\n…(truncated)' : ''}</pre>
      </div>
    `;

    const btn = document.createElement('button');
    btn.textContent = 'Download';
    btn.onclick = () => saveAs(splitFiles[i].blob, splitFiles[i].name);

    li.appendChild(btn);
    outputList.appendChild(li);
  });
}

// ------------------ ZIP Download ------------------
$('downloadZip').onclick = async () => {
  if (!splitFiles.length) return;
  setStatus('Creating ZIP...');

  const zip = new JSZip();
  splitFiles.forEach(f => zip.file(f.name, f.blob));

  const blob = await zip.generateAsync({type: 'blob'});
  saveAs(blob, 'image_splits.zip');
  setStatus(`ZIP downloaded.`);
};

// Show file name on selection
fileInput.onchange = () => {
  if (fileInput.files[0]) setStatus('Selected: ' + fileInput.files[0].name);
};
</script>
</body>
</html>
